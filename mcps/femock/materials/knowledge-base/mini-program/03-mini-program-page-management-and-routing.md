# 小程序页面管理与路由深度解析

本文档详细记录了《页面管理与跳转》一文中的核心知识点，聚焦于小程序的页面栈、多 WebView 模型、路由机制和生命周期，为 AI 提供构建面试题的深度物料。

## 1. 核心架构：多 WebView 模型

与传统的单页应用 (SPA) 不同，小程序在架构上更接近于原生 App 的多页面模型。

- **一个页面 = 一个 WebView**: 小程序的每一个页面都独立运行在自己的 WebView 容器中。
- **优势**:
    - **体验流畅**: 页面间的切换（特别是手势返回）可以实现接近原生的动画效果。
    - **环境隔离**: 每个页面的视图环境是隔离的，简化了样式和 DOM 管理。

## 2. 页面栈 (Page Stack)

小程序框架通过一个 **页面栈** 来管理所有页面的层级关系。这个栈的行为类似于一个数组，后进先出。

- **栈顶**: 用户当前看到的页面，就是位于栈顶的页面。
- **栈容量**: 页面栈最多只能存放 **10** 个页面。
- **获取页面栈**: 可以通过全局方法 `getCurrentPages()` 获取当前所有页面的实例数组。

## 3. 路由机制 (Routing)

小程序的路由操作，本质上就是对这个页面栈进行“入栈”和“出栈”操作。

### a. 导航 API

- **`wx.navigateTo(Object object)`**:
    - **功能**: 保留当前页面，跳转到一个新的非 TabBar 页面。
    - **栈行为**: **入栈 (Push)**。新页面被压入栈顶。
    - **限制**: 不能跳转到 TabBar 页面，且不能超过 10 层栈深。

- **`wx.redirectTo(Object object)`**:
    - **功能**: 关闭当前页面，跳转到一个新的非 TabBar 页面。
    - **栈行为**: **替换 (Replace)**。当前页面（栈顶）先出栈，然后新页面再入栈。
    - **使用场景**: 登录成功后，从登录页跳转到首页，此时登录页不需要保留在历史记录中。

- **`wx.navigateBack(Object object)`**:
    - **功能**: 关闭当前页面，返回上一页面或多级页面。
    - **栈行为**: **出栈 (Pop)**。页面从栈顶被移除。
    - **参数**: 可以通过 `delta` 参数指定返回的层数。

- **`wx.switchTab(Object object)`**:
    - **功能**: 跳转到 TabBar 页面。
    - **栈行为**: **清空非 TabBar 页面**。跳转后，页面栈中只会剩下目标 TabBar 页面，之前的所有非 TabBar 页面都会被销毁。

- **`wx.reLaunch(Object object)`**:
    - **功能**: 关闭所有页面，打开到应用内的某个页面。
    - **栈行为**: **清空所有页面**。页面栈被完全清空，然后目标页面作为新的栈底页面入栈。
    - **使用场景**: 从一个很深的页面层级返回到首页。

## 4. 页面生命周期 (Page Lifecycle)

生命周期函数是小程序框架与开发者沟通的桥梁，在页面的不同阶段自动触发。

- **`onLoad(Object query)`**:
    - **时机**: 页面 **加载** 时触发，一个页面只会调用一次。
    - **作用**: 适合进行页面初始化的网络请求、获取路由参数 (`query`) 等。

- **`onShow()`**:
    - **时机**: 页面 **显示** 或切入前台时触发。每次打开页面都会调用。
    - **作用**: 适合更新与用户状态相关的 UI 或数据。

- **`onReady()`**:
    - **时机**: 页面 **初次渲染完成** 后触发，一个页面只会调用一次。
    - **作用**: 此时可以与视图层进行交互，例如获取 WXML 节点的尺寸信息。

- **`onHide()`**:
    - **时机**: 页面 **隐藏** 或切入后台时触发（如 `navigateTo` 到新页面、切换 Tab、按 Home 键等）。
    - **作用**: 必须在此处清理定时器、停止动画等耗时操作。

- **`onUnload()`**:
    - **时机**: 页面 **卸载** 时触发（如 `redirectTo` 或 `navigateBack` 时）。
    - **作用**: 进行最终的资源清理。

## 5. 逻辑层共享的注意事项

虽然每个页面的 **视图层 (WebView)** 是隔离的，但所有页面的 **逻辑层 (JS)** 都运行在 **同一个 JSCore 线程** 中。这意味着：
- **数据共享**: 可以通过 `getApp()` 或 `getCurrentPages()` 访问和修改其他页面的数据。
- **资源竞争**: 后台页面的 `setInterval` 或未完成的网络请求会继续占用资源，可能影响前台页面的性能。因此，在 `onHide` 中进行清理至关重要。

# React Native Code Push 热更新深度解析

本文档详细记录了《Code Push 热更新》一文中的核心知识点，聚焦于其原理、架构、工作流程和更新策略，为 AI 提供构建面试题的深度物料。

## 1. 背景：为什么需要热更新？

- **传统 App 更新的痛点**:
    - **审核周期长**: 每次发布新版本都需要经过苹果 App Store 或安卓各大应用市场的审核，通常需要数小时到数天不等。
    - **无法快速修复 Bug**: 对于线上的紧急 Bug，无法立即修复并推送给用户。
    - **更新率低**: 用户并非总会立即更新到最新版本的 App，导致版本碎片化严重。

- **热更新 (Hot Update) 的价值**:
    - **定义**: 在不发布新版 App 的情况下，通过服务器推送更新包，动态更新 App 的业务逻辑和资源。
    - **核心优势**:
        - **绕过应用商店审核**，实现快速、静默的更新。
        - **实时修复线上 Bug**。
        - **提高用户更新率**，保证大部分用户体验的一致性。

## 2. Code Push 架构

Code Push 是微软提供的一套针对 React Native 和 Cordova 应用的热更新服务。其架构主要包含三部分：

1.  **Code Push 服务器 (Server)**:
    - **职责**: 托管所有已发布的更新包。每个更新包都与特定的 App 版本、部署环境（如 `Production`, `Staging`）相关联。

2.  **管理 CLI (Command-Line Interface)**:
    - **职责**: 供开发者使用的命令行工具。
    - **功能**:
        - `release-react`: 将 RN 的 JS Bundle 和资源打包并发布到 Code Push 服务器。
        - `deployment ls -l`: 查看各个部署环境的发布历史。
        - `rollback`: 回滚某个版本的更新。

3.  **客户端 SDK (`react-native-code-push`)**:
    - **职责**: 集成在 RN 应用内部，负责与服务器通信并执行更新逻辑。
    - **功能**: 检查更新、下载更新包、安装更新、回滚等。

## 3. Code Push 工作流程

1.  **检查更新 (Check)**:
    - App 在特定时机（如启动时、从后台切换到前台时）向 Code Push 服务器发送请求，查询是否有适用于当前 App 版本和部署环境的新更新。
    - 请求中会携带当前 App 的版本号和已安装更新包的 hash 值。

2.  **下载更新 (Download)**:
    - 如果服务器上有新版本，SDK 会在后台下载这个更新包（一个 `.zip` 文件，包含了新的 `jsbundle` 和资源）。
    - 下载过程是静默的，对用户无感知。

3.  **安装更新 (Install)**:
    - 下载完成后，SDK 会将更新包解压到 App 的本地存储区。
    - 然后，根据设定的 **安装策略**，在合适的时机让 App 重新加载 JS Bundle，从而让新的代码生效。

4.  **回滚 (Rollback)**:
    - 如果新版本的代码在启动后连续两次崩溃，SDK 会认为这是一个失败的更新，并自动回滚到更新前的最后一个可用版本，以保证应用的稳定性。

## 4. 核心更新策略 (Install Modes)

SDK 提供了多种策略来控制更新的安装时机，以平衡更新的及时性和用户体验：

- **`IMMEDIATE` (立即安装)**:
    - **时机**: 更新包下载完成后，立即重启 App 以应用更新。
    - **优点**: 更新最及时。
    - **缺点**: 可能会打断用户的当前操作，体验较差。适用于强制更新的关键 Bug 修复。

- **`ON_NEXT_RESTART` (下次启动时安装)**:
    - **时机**: 更新包下载后，不做任何操作。直到用户下一次 **冷启动** (完全关闭 App 后再打开) 时，才应用更新。
    - **优点**: 用户体验最好，无感知。
    - **缺点**: 更新不及时，用户可能在很久之后才重启 App。

- **`ON_NEXT_RESUME` (下次恢复时安装)**:
    - **时机**: 更新包下载后，在用户将 App 从后台切换到前台时，应用更新。
    - **优点**: 平衡了及时性和用户体验，是 **最常用** 的策略。

- **`ON_NEXT_SUSPEND` (下次挂起时安装)**:
    - **时机**: 更新包下载后，在用户将 App 从前台切换到后台，且在后台停留超过一定时间（`minimumBackgroundDuration`）后，静默安装。
    - **优点**: 同样是无感知的更新方式。

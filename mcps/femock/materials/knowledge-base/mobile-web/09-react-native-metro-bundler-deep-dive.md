# React Native Metro 打包工具深度解析

本文档详细记录了《Metro Bundler》一文中的核心知识点，聚焦于 Metro 的工作流程、核心架构和关键特性，为 AI 提供构建面试题的深度物料。

## 1. Metro 的角色

Metro 是专为 React Native 设计的 JavaScript 打包工具 (Bundler)。与 Web 开发中的 Webpack 类似，它的核心职责是：

- **依赖解析**: 从入口文件开始，分析代码中的 `import`/`require` 语句，构建出整个应用的依赖关系图。
- **代码转换**: 将 JSX、TypeScript、ES6+ 等现代 JavaScript 语法转换为目标 JS 引擎（如 Hermes, JSCore）能够理解的代码。
- **资源打包**: 将所有 JS 模块和静态资源（如图片）打包成一个或多个 `jsbundle` 文件，供 RN 应用在运行时加载。
- **开发服务**: 提供快速的开发服务器，支持 **热模块替换 (HMR)** 和秒级的重载速度。

## 2. Metro 的三阶段架构

Metro 的打包过程可以清晰地分为三个阶段：

### a. Resolution (解析阶段)

- **目标**: 构建应用的完整 **依赖图 (Dependency Graph)**。
- **流程**:
    1.  从指定的入口文件（如 `index.js`）开始。
    2.  分析该文件的代码，找出所有的依赖项（`import` 和 `require`）。
    3.  递归地对每个依赖项重复此过程，直到所有模块都被找到并添加到图中。
- **产物**: 一个包含了所有模块及其相互依赖关系的数据结构。

### b. Transformation (转换阶段)

- **目标**: 将所有模块的代码转换为目标平台兼容的格式。
- **核心工具**: **Babel**。
- **流程**:
    1.  Metro 会为每个模块文件调用 Babel 进行语法转换。
    2.  主要转换内容包括：
        - JSX -> `React.createElement()`
        - TypeScript -> JavaScript
        - ES6+ 语法 -> ES5 (取决于配置)
        - Flow 类型注解移除
    3.  **并行处理**: Metro 会启动多个 Worker 进程来 **并行** 地执行转换操作，极大地提高了大型项目的打包速度。
- **产物**: 一系列内容已被转换的模块。

### c. Serialization (序列化/打包阶段)

- **目标**: 将所有转换后的模块合并成最终的 `jsbundle` 文件。
- **流程**:
    1.  将所有模块按照特定的顺序（通常是模块 ID）拼接在一起。
    2.  添加一个模块加载器（Runtime），用于在运行时实现 `require()` 功能。
    3.  生成最终的 `bundle` 文件。
- **产物**: 一个或多个 `.jsbundle` 文件。

## 3. Metro 的关键特性

### 3.1 极速的开发体验

- **缓存**: Metro 拥有强大的缓存系统 (`metro-cache`)。它会对每个文件的转换结果进行缓存。当文件未发生变化时，再次打包会直接使用缓存，实现了秒级的重载。
- **内存优先**: Metro 将整个依赖图保留在内存中，当文件发生变更时，只需对变更的部分进行增量更新，而无需重新完整构建依赖图。

### 3.2 热模块替换 (Hot Module Replacement - HMR)

- **定义**: 允许在应用运行时，只更新修改过的模块，而无需重新加载整个应用，并且 **保留应用的当前状态** (State)。
- **意义**: 极大地提升了开发调试效率。例如，修改一个组件的样式后，可以在不丢失当前页面状态的情况下，立即看到样式的变化。

### 3.3 静态资源处理

- Metro 内置了资源文件处理能力。当代码中 `require` 一张图片时（如 `require('./my-image.png')`），Metro 会：
    1.  解析图片，获取其尺寸等元数据。
    2.  将图片资源打包到 App 的资源目录中。
    3.  在 JS 代码中，`require` 的返回值会是一个包含图片信息的对象，供 `Image` 组件使用。

## 4. 代码拆分 (Code Splitting)

- **现状**: Metro **原生不支持** 像 Webpack 那样成熟的代码拆分（Code Splitting）功能。
- **社区方案**: 存在一些第三方工具（如 `metro-code-split`），它们通过利用 `import()` 动态导入语法，并结合修改 Metro 配置，可以实现一定程度的代码按需加载，从而优化 App 的初始加载性能。
